---
title: "Typhoid Seroincidence"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Typhoid Seroincidence}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
bibliography: ../references.bib
---
# Introduction

This vignette provides users with an example analysis using the *serocalculator* package. Users will be able to determine the seroincidence of typhoid fever in the sample population using existing longitudinal antibody dynamics collected from Bangladesh, Ghana, Nepal, and Pakistan [@Aiemjoy_2022_Lancet], plus a cross-sectional serosurvey from a simulated population. 


```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```
# Sample Analysis
## 1. Load packages
The first step in conducting this analysis is to load our necessary packages. Follow the [installation instructions](https://ucd-serg.github.io/serocalculator/) if you have not already installed *serocalculator*. 

```{r setup, message=FALSE}

library(devtools)
#install_github("UCD-SERG/serocalculator")
library(serocalculator)
library(tidyverse)

```
## 2. Load data
### a. Load and prepare longitudinal parameter data
The next step is to load the longitudinal data to set the antibody decay parameters. In this example, these parameters were modeled with Bayesian hierarchical models to fit two-phase power-function decay models to the longitudinal antibody responses among confirmed enteric fever cases.

These parameters include the following:

  * $y_0$ = baseline  
  * $y_1$ = peak antibody responses 
  * $t_1$ = time to peak 
  * $\alpha$ = decay rate
  * $r$ = decay shape 

We also create two additional variables: the annual decay rate, $\alpha$, which is calculated from the daily decay rate in this example, and $d$, which is the decay shape, or 1-$r$.

Finally, we select only the variables needed for the analysis. 

```{r longdata, echo=FALSE, message=FALSE}
c.hlye.IgG <- 
  fs::path_package(                          
  "extdata", 
  "dmcmc_hlyeigg_09.30.rds", 
  package = "serocalculator") |> #Load longitudinal parameters dataset
 readRDS()%>%
  mutate(alpha = alpha*365.25, #Create alpha and d 
         d = r-1) %>%
  select(y1, alpha, d) #Select only the variables needed for analysis
```

### b. Load and prepare simulated data 
The simulated data represents a cross-sectional serosurvey conducted in a representative sample of the general population without regard to disease status. 

In this scenario, we have selected hlye and IgG as our target measures. Users may select different serologic markers depending on what is available. From the original dataset, we rename our variables to *y* and *a*. Finally, we once again limit the dataset to only the variables needed for the analysis. 

``` {r simdata, message=FALSE}
library(fs) # filesystem utility functions
p.hlye.IgG  <- 
  fs::path_package(
    package = "serocalculator", 
    "extdata/simpophlyeigg.2.csv") %>% #Load  cross-sectional dataset
  read_csv() %>%
  rename( #rename variables
    y = y.smpl,
    a = a.smpl) %>% 
  select(y, a) #Select only the variables needed for analysis
```


### c. Set conditions for simulated data
Next, we must set conditions based on some assumptions about the simulated data. This will differ based on background knowledge of the cross-sectional data. 

The biological noise, $\nu$ ("nu"), represents error from cross-reactivity to other antibodies in addition to those for the target condition. This can artificially inflate quantitative antibody result. Measurement noise, $\varepsilon$ ("epsilon"), represents error from the laboratory testing process. 

``` {r conditions, message=FALSE}
cond.hlye.IgG <- data.frame(
  nu = 1.027239,             # Biological noise
  eps = 0.2,            # Measurement noise
  y.low = 0.0,          # low cutoff
  y.high = 5e4); # high cutoff
```


## 3. Estimate Seroincidence
Finally, we are ready to begin seroincidence estimation. We define our starting value as 0.5, which will also define our initial estimate for the force of infection (FOI, $\lambda$ ("lambda")). Then we log transform $\lambda$ and set up maximum and minimum values for the confidence interval. 


```{r seroinc}
start <- .05 #Set starting value

lambda = start #initial estimate: starting value
log.lambda = log(lambda)
log.lmin=log(lambda/10)
log.lmax=log(10*lambda) 


objfunc <- function(llam){
  return(res <- fdev(llam, p.hlye.IgG, c.hlye.IgG, cond.hlye.IgG))
}

fit <- nlm(objfunc,log.lambda,
           hessian=TRUE,print.level=0,stepmax=(log.lmax-log.lmin)/4)

#Calculate lambda, lower, upper, LF min
log.lambda.est <- c(exp(fit$estimate),
                    exp(fit$estimate + qnorm(c(0.025))*sqrt(1/fit$hessian)),
                    exp(fit$estimate + qnorm(c(0.975))*sqrt(1/fit$hessian)),
                    fit$minimum)

#Print the final results
log.lambda.est
```

## Conclusions
In our simulated data, we found that the estimated seroincidence of typhoid is 0.20 (95% CI: 0.18, 0.23). 


## References
