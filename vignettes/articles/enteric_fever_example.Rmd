---
title: "Enteric Fever Example"
author: "UC Davis Seroepidemiology Research Group (SERG)"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Enteric Fever Example}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
bibliography: references.bib


---
# Introduction

This vignette provides users with an example analysis using the **serocalculator** package by reproducing an analysis in [@Aiemjoy_2022_Lancet]. 

## Methods

The **serocalculator** R package provides a rapid and computationally simple method for calculating seroconversion rates, as originally published in [@Simonsen_2009;@Teunis_2012], and further developed by subsequent publications [@de_Graaf_2014] and [@Teunis_2016]. In short, longitudinal seroresponses from confirmed cases with a known symptom onset date are assumed to represent the time course of human serum antibodies against a specific pathogen. Therefore, by using these longitudinal antibody dynamics with any cross–sectional sample of the same antibodies in a human population, an incidence estimate can be calculated. Further details are below.

### A Proxy for Infection 
 
While the exact time of infection is impossible to measure in an individual, antibody levels measured in a cross–sectional population sample can be translated into an estimate of the frequency with which seroconversions (infections) occur in the sampled population. In simple terms: the presence of many high antibody concentrations indicates that many subjects likely experienced infection recently, while mostly low concentrations indicate a low frequency of infections in the sampled population.

In order to interpret the measured cross-sectional antibody concentrations in terms of incidence, we must define the antibody dynamic over time to understand the generalized antibody response at different times since infection. For any antibody detected in the cross–sectional sample, a quantitative description of its dynamics following infection (seroconversion to an elevated concentration, followed by a gradual decrease) must be available. In published studies, this information on the time course of the serum antibody response has been obtained from longitudinal follow–up data in subjects who had a symptomatic episode following infection. 

In this case, the onset of symptoms then provides a proxy for the time that infection occurred. 

### Assumptions and Cautions
Care must be taken that longitudinal and cross–sectional measurements of antibody concentrations are calibrated on the same scale (or, preferably, expressed in identical units). Ideally they will be obtained using the same diagnostic test. 

The time course of the serum antibody response to infection is assumed generic: anyone infected by the same pathogen is expected to produce a response similar to those seen in the symptomatic cohort used for the follow–up study. Thus, the strategy is to set up a longitudinal model from a follow–up study once, and use the thus obtained information to analyze many different cross–sectional data sets.

Note that it must be assumed that such variation in the time course of antibody concentrations among individuals as observed in the longitudinal cohort is the same as in the population where the cross-sectional sample was taken, where this variation cannot be observed.

Analysis of longitudinal data and estimation of the required parameters is separated from the 
estimation of seroincidences, because (1) there are few longitudinal data sets available and they 
are difficult (and expensive) to obtain, (2) such longitudinal models may be considered *generic*, presumably describing a physiological phenomenon that is similiar in any infected individual, and 
(3) setting up and running the longitudinal model requires additional skills, not necessary for use of this package.

#### The seroincidence estimator

The **serocalculator** package was designed to calculate the incidence of seroconversion, by using the longitudinal seroresponse characteristics. The distribution of serum antibody concentrations in a cross–sectional population sample is calculated, as a function of the longitudinal seroresponse and the frequency of seroconversion (or seroincidence). Given the seroresponse, this marginal distribution of antibody concentrations can be fitted to the cross-sectional data, by adjusting the seroconversion frequency, thus providing a means to estimate the seroconversion frequency.

## Example: Enteric Fever

Users will determine the seroincidence of enteric fever in cross-sectional serosurveys conducted as part of the the SErologic and Environmental Surveillance (SEES) for enteric fever study in Bangladesh, Nepal, and Pakistan. Longitudinal antibody responses were modeled from 1420 blood culture-confirmed enteric fever cases enrolled from the same countries. 

Further details on this published study can be found here: https://doi.org/10.1016/S2666-5247(22)00114-8. 

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```
# Sample Analysis
## Load packages
The first step in conducting this analysis is to load our necessary packages. 

```{r setup, message=FALSE}

library(serocalculator)
library(tidyverse)
library(ggplot2)

```
## Load data


### Load and prepare longitudinal parameter data

The first step is to load the longitudinal data to set the antibody decay parameters. We use the function `getAdditionalData` to pull existing Enteric fever parameters from the [Serocalculator Repository](https://osf.io/ne8pc/) on Open Science Framework (OSF), which houses sample datasets and pathogen-specific longitudinal antibody dynamics for **serocalculator**. 

In this example, these parameters were modeled with Bayesian hierarchical models to fit two-phase power-function decay models to the longitudinal antibody responses among confirmed enteric fever cases. 

These parameters include the following:

  * $y_0$ = baseline antibody response
  * $y_1$ = peak antibody responses 
  * $t_1$ = time to peak 
  * $\alpha$ = decay rate in years (may need to be rescaled)
  * $r$ = decay shape 


We also create an additional variables $d$, which is the decay shape, or 1-$r$.


```{r curve, echo=FALSE, message=FALSE}
#Import longitudinal antibody parameters from OSF
#This is the URL for Enteric Fever Curve Parameters called "SEES_mcmc_unstratified_df.rds"

curve_param = getAdditionalData(fileURL ="https://osf.io/download/rtw5k/")
  

```

### Load and prepare cross-sectional data 
We will use a subset of results from the SEES dataset as our cross-sectional data. Ideally, this will be a representative sample of the general population without regard to disease status. Here, we will limit our analysis to cross-sectional data from Pakistan. 

In this scenario, we will limit our analysis to data from Pakistan. We have selected hemolysin E (**HlyE**) as our target antigen and **IgG** and **IgA** as our target immunoglobulin isotypes. Users may select different serologic markers depending on what is available in your data. From the original dataset, we rename our result and age variables to *y* and *a*, respectively. Finally, we once again limit the dataset to only the variables needed for the analysis. 

```{r data, message = FALSE}

pop_data <- getAdditionalData(fileURL ="https://osf.io/download//n6cp3/") %>%
  rename(value = result,
         age = Age)
  
```


## Visualize antibody data

Get to know your cross-sectional antibody data by visualizing the distribution of quantitative antibody responses. We have selected HlyE as the antigen of interest, and both IgA and IgG as the isotypes of interest. Here, we will look at the distribution of HlyE IgA and HlyE IgG. 

```{r hist, message = FALSE}
#Graph your data as a histogram

ggplot(pop_data, aes(x = value)) +
  #geom_histogram(binwidth = 5, color = "#000000", fill = "#009999", alpha = 0.7) +
  geom_histogram(aes(fill = Country), alpha = .7, color = "black") +
  theme_minimal() +
  labs(
    title = "Distribution of Cross-sectional Antibody Responses",
    x = "Antibody Response Value",
    y = "Frequency"
  ) +
  facet_wrap(~Country + antigen_iso, nrow = 3)

# Save the plot with a specified width
#ggsave("output_plot.html", plot = histogram, width = 5, height = 3, units = "in", device = "html")

```

Here, we see that our data is highly skewed with the majority of responses on the lower end of our data, but there is a long tail stretching to over 200. Let's get a better look at the distribution by log transforming our *y* response. We will also need to update the bin width. 

```{r loghist, message = FALSE}
#Let's log transform your data to better visualize the distribution. We will also need to update the bin width. 

ggplot(pop_data, aes(x = value)) +
  #geom_histogram(binwidth = 0.05, color = "#000000", fill = "#009999", alpha = 0.7) +
  geom_histogram(aes(fill = Country), alpha = .7, color = "black") +
  scale_x_log10() +
  theme_minimal() +
  labs(
    title = "Distribution of Cross-sectional Antibody Responses (Log transformed)",
    x = "Log10(Antibody Response Value)",
    y = "Frequency"
  ) +
  facet_wrap(~Country + antigen_iso, nrow = 3)

```

Once log transformed, our data looks much more normally distributed. In most cases, log transformation will be the best way to visualize serologic data. 


### Load noise parameters

Next, we must set conditions based on some assumptions about the simulated data. This will differ based on background knowledge of the cross-sectional data. 

The biological noise, $\nu$ ("nu"), represents error from cross-reactivity to other antibodies. Measurement noise, $\varepsilon$ ("epsilon"), represents error from the laboratory testing process. 


``` {r noise, message=FALSE}

noise_param <- getAdditionalData(fileURL ="https://osf.io/download//hqy4v/") %>%
  rename(y.low = llod)

```



## Estimate Seroincidence 
Finally, we are ready to begin seroincidence estimation. We will conduct two separate analyses using two distinct functions, `est.incidence` and `est.incidence.by`, to calculate the overall seroincidence and the age-specific incidence, respectively.

### Overall Seroincidence
We define our starting value as 0.2, which will also define our initial estimate for the force of infection (FOI, $\lambda$ ("lambda")). Then we log transform $\lambda$ and set up maximum and minimum values for the confidence interval. 

```{r est, message= FALSE}


#Using est.incidence (no strata)
esttest = est.incidence(
  stepmax = 1,
  verbose = TRUE,
  start=.2,
  data = pop_data %>% filter(Country == "Pakistan"),
  curve_param = curve_param, 
  noise_param = noise_param %>% filter(Country == "Pakistan"),
  antigen_isos = c("HlyE_IgG")
)



summary(esttest)
```

### Stratified Seroincidence

```{r estby, message=FALSE}

estbytest = est.incidence.by(
  stepmax = 1,
  verbose = TRUE,
  lambda.start=.3,
  strata = c("catchment"),
  data = pop_data %>% filter(Country == "Pakistan"),
  curve_params = curve_param, 
  noise_params = noise_param %>% filter(Country == "Pakistan"),
  build_graph = FALSE
)


summary(estbytest)

```


## Conclusions
In our data, we found that the overall estimated seroincidence of enteric fever in Pakistan is 11.8 per 100 persons (95% CI: 11.0, 12.5). When stratified by sex, we found that males have a higher incidence rate than females [18.4 per 100 persons (95% CI: 17.6, 19.4) vs. 15.3 per 100 persons (95% CI: 14.6, 16.0). 


## References
