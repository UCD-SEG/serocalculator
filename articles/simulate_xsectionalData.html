<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="serocalculator">
<title>Generate a simulated cross-sectional sample and estimate seroincidence • serocalculator</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Generate a simulated cross-sectional sample and estimate seroincidence">
<meta property="og:description" content="serocalculator">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">serocalculator</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/enteric_fever_example.html">Enteric Fever Example</a>
    <a class="dropdown-item" href="../articles/sees_analysis.html">sees-analysis</a>
    <a class="dropdown-item" href="../articles/simulate_xsectionalData.html">Generate a simulated cross-sectional sample and estimate seroincidence</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/UCD-SERG/serocalculator/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">



<script src="simulate_xsectionalData_files/htmlwidgets-1.6.3/htmlwidgets.js"></script><link href="simulate_xsectionalData_files/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="simulate_xsectionalData_files/datatables-binding-0.30/datatables.js"></script><link href="simulate_xsectionalData_files/dt-core-1.13.4/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="simulate_xsectionalData_files/dt-core-1.13.4/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="simulate_xsectionalData_files/dt-core-1.13.4/js/jquery.dataTables.min.js"></script><link href="simulate_xsectionalData_files/crosstalk-1.2.0/css/crosstalk.min.css" rel="stylesheet">
<script src="simulate_xsectionalData_files/crosstalk-1.2.0/js/crosstalk.min.js"></script><div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Generate a simulated cross-sectional sample and estimate seroincidence</h1>
            <h3 data-toc-skip class="subtitle">Enteric Fever using HlyE
IgG and/or HlyE IgA</h3>
            
      
      <small class="dont-index">Source: <a href="https://github.com/UCD-SERG/serocalculator/blob/HEAD/vignettes/articles/simulate_xsectionalData.Rmd" class="external-link"><code>vignettes/articles/simulate_xsectionalData.Rmd</code></a></small>
      <div class="d-none name"><code>simulate_xsectionalData.Rmd</code></div>
    </div>

    
    
<p>This vignette shows how to simulate a cross-sectional sample of
seroresponses for incident infections as a Poisson process with
frequency <code>lambda</code>. Responses are generated for the
antibodies given in the <code>antigen_isos</code> argument.</p>
<p>Age range of the simulated cross-sectional record is
<code>lifespan</code>.</p>
<p>The size of the sample is <code>nrep</code>.</p>
<p>Each individual is simulated separately, but different antibodies are
modelled jointly.</p>
<p>Longitudinal parameters are calculated for an age:
<code>age.fx</code> (fixed age). However, when <code>age.fx</code> is
set to NA then the age at infection is used.</p>
<p>The boolean <code>renew.params</code> determines whether each
infection uses a new set of longitudinal parameters, sampled at random
from the posterior predictive output of the longitudinal model. If set
to <code>FALSE</code> a parameter set is chosen at birth and kept, but:
1. the baseline antibody levels (<code>y0</code>) are updated with the
simulated level (just) prior to infection, and 2. when
<code>is.na(age.fx)</code> then the selected parameter sample is updated
for the age when infection occurs.</p>
<p>There is also a variable <code>n.mc</code>: when <code>n.mc==0</code>
then a random MC sample is chosen out of the posterior set (1:4000).
When <code>n.mc</code> is given a value in 1:4000 then the chosen number
is fixed and reused in any subsequent infection. This is for diagnostic
purposes.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/UCD-SERG/serocalculator" class="external-link">serocalculator</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; ── <span style="font-weight: bold;">Attaching core tidyverse packages</span> ──────────────────────── tidyverse 2.0.0 ──</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">dplyr    </span> 1.1.4     <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">readr    </span> 2.1.4</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">forcats  </span> 1.0.0     <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">stringr  </span> 1.5.1</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">ggplot2  </span> 3.4.4     <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">tibble   </span> 3.2.1</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">lubridate</span> 1.9.3     <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">tidyr    </span> 1.3.0</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">purrr    </span> 1.0.2     </span></span>
<span><span class="co">#&gt; ── <span style="font-weight: bold;">Conflicts</span> ────────────────────────────────────────── tidyverse_conflicts() ──</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> <span style="color: #0000BB;">dplyr</span>::<span style="color: #00BB00;">filter()</span> masks <span style="color: #0000BB;">stats</span>::filter()</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> <span style="color: #0000BB;">dplyr</span>::<span style="color: #00BB00;">lag()</span>    masks <span style="color: #0000BB;">stats</span>::lag()</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Use the conflicted package (<span style="color: #0000BB; font-style: italic;">&lt;http://conflicted.r-lib.org/&gt;</span>) to force all conflicts to become errors</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/eclarke/ggbeeswarm" class="external-link">ggbeeswarm</a></span><span class="op">)</span> <span class="co"># for plotting</span></span>
<span></span>
<span><span class="co">#load in longitudinal parameters, these are modelled from all SEES cases across all ages and countries </span></span>
<span><span class="va">dmcmc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/getAdditionalData.html">getAdditionalData</a></span><span class="op">(</span>fileURL <span class="op">=</span> <span class="st">"https://osf.io/download/rtw5k"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="simulate-cross-sectional-data">Simulate cross-sectional data<a class="anchor" aria-label="anchor" href="#simulate-cross-sectional-data"></a>
</h3>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#set seed to reproduce results</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">54321</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Specify the antibody-isotype responses to simulate</span></span>
<span><span class="va">antibodies</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"HlyE_IgA"</span>, <span class="st">"HlyE_IgG"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># simulated incidence rate per person-year</span></span>
<span><span class="va">lambda</span> <span class="op">&lt;-</span> <span class="fl">0.2</span>;</span>
<span></span>
<span><span class="co"># range covered in simulations</span></span>
<span><span class="va">lifespan</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">20</span><span class="op">)</span>; </span>
<span></span>
<span><span class="co"># cross-sectional sample size</span></span>
<span><span class="va">nrep</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span></span>
<span><span class="co"># biologic noise distribution</span></span>
<span><span class="va">dlims</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.01</span>, <span class="fl">0.5</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.01</span>, <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#generate cross-sectional data</span></span>
<span><span class="va">csdata0</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim.cs.html">sim.cs</a></span><span class="op">(</span></span>
<span>  curve_params <span class="op">=</span> <span class="va">dmcmc</span>,</span>
<span>  lambda <span class="op">=</span> <span class="va">lambda</span>,</span>
<span>  n.smpl <span class="op">=</span> <span class="va">nrep</span>,</span>
<span>  age.rng <span class="op">=</span> <span class="va">lifespan</span>,</span>
<span>  antigen_isos <span class="op">=</span> <span class="va">antibodies</span>,</span>
<span>  n.mc <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  renew.params <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  add.noise <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  noise_limits <span class="op">=</span> <span class="va">dlims</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="estimate-seroincidence">Estimate seroincidence<a class="anchor" aria-label="anchor" href="#estimate-seroincidence"></a>
</h3>
<p>We need to provide noise parameters for the analysis; here, we define
them directly in our code:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cond</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  antigen_iso <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"HlyE_IgG"</span>, <span class="st">"HlyE_IgA"</span><span class="op">)</span>,</span>
<span>  nu <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">0.5</span><span class="op">)</span>,  <span class="co"># Biologic noise (nu)</span></span>
<span>  eps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="fl">0.2</span><span class="op">)</span>,                             <span class="co"># M noise (eps)</span></span>
<span>  y.low <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>,                            <span class="co"># low cutoff (llod)</span></span>
<span>  y.high <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5e6</span>, <span class="fl">5e6</span><span class="op">)</span><span class="op">)</span>                      <span class="co"># high cutoff (y.high)</span></span></code></pre></div>
<p>We also need to convert the data to a long format for analysis:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">csdataL</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">csdata0</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span></span>
<span>    cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"HlyE_IgG"</span>, <span class="st">"HlyE_IgA"</span><span class="op">)</span>, </span>
<span>    names_to <span class="op">=</span> <span class="st">"antigen_iso"</span>, </span>
<span>    values_to <span class="op">=</span> <span class="st">"value"</span><span class="op">)</span></span></code></pre></div>
<p>We can plot the distribution of the antibody responses in the
simulated data.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">csdataL</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">antigen_iso</span><span class="op">)</span>, y<span class="op">=</span> <span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/ggbeeswarm/man/geom_beeswarm.html" class="external-link">geom_beeswarm</a></span><span class="op">(</span>size<span class="op">=</span> <span class="fl">.2</span>, alpha <span class="op">=</span> <span class="fl">.3</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">antigen_iso</span><span class="op">)</span>, show.legend <span class="op">=</span> <span class="cn">F</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html" class="external-link">geom_boxplot</a></span><span class="op">(</span>outlier.colour <span class="op">=</span> <span class="cn">NA</span>, fill <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_log10</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_linedraw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x<span class="op">=</span><span class="st">"antigen - isotype"</span><span class="op">)</span></span></code></pre></div>
<p><img src="simulate_xsectionalData_files/figure-html/unnamed-chunk-2-1.png" width="672"></p>
<p>We can estimate incidence with <code><a href="../reference/est.incidence.html">est.incidence()</a></code>:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">est1</span> <span class="op">=</span> <span class="fu"><a href="../reference/est.incidence.html">est.incidence</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">csdataL</span>,</span>
<span>  curve_params <span class="op">=</span> <span class="va">dmcmc</span>,</span>
<span>  noise_params <span class="op">=</span> <span class="va">cond</span>,</span>
<span>  lambda.start <span class="op">=</span> <span class="fl">.1</span>,</span>
<span>  build_graph <span class="op">=</span> <span class="cn">T</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">T</span>, <span class="co"># print updates as the function runs</span></span>
<span>  print_graph <span class="op">=</span> <span class="cn">F</span>, <span class="co"># display the log-likelihood curve while `est.incidence()` is running</span></span>
<span>  antigen_isos <span class="op">=</span> <span class="va">antibodies</span><span class="op">)</span></span>
<span><span class="co">#&gt; nrow(curve_params) = 8000</span></span>
<span><span class="co">#&gt; Initial negative log-likelihood: 596.061590080415</span></span>
<span><span class="co">#&gt; building likelihood graph</span></span>
<span><span class="co">#&gt; about to call `nlm()`</span></span>
<span><span class="co">#&gt; iteration = 0</span></span>
<span><span class="co">#&gt; Step:</span></span>
<span><span class="co">#&gt; [1] 0</span></span>
<span><span class="co">#&gt; Parameter:</span></span>
<span><span class="co">#&gt; [1] -2.302585</span></span>
<span><span class="co">#&gt; Function Value</span></span>
<span><span class="co">#&gt; [1] 596.0616</span></span>
<span><span class="co">#&gt; Gradient:</span></span>
<span><span class="co">#&gt; [1] -58.97818</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; iteration = 1</span></span>
<span><span class="co">#&gt; Step:</span></span>
<span><span class="co">#&gt; [1] 0.6182714</span></span>
<span><span class="co">#&gt; Parameter:</span></span>
<span><span class="co">#&gt; [1] -1.684314</span></span>
<span><span class="co">#&gt; Function Value</span></span>
<span><span class="co">#&gt; [1] 573.4109</span></span>
<span><span class="co">#&gt; Gradient:</span></span>
<span><span class="co">#&gt; [1] -10.88708</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; iteration = 2</span></span>
<span><span class="co">#&gt; Step:</span></span>
<span><span class="co">#&gt; [1] 0.1399671</span></span>
<span><span class="co">#&gt; Parameter:</span></span>
<span><span class="co">#&gt; [1] -1.544347</span></span>
<span><span class="co">#&gt; Function Value</span></span>
<span><span class="co">#&gt; [1] 572.8277</span></span>
<span><span class="co">#&gt; Gradient:</span></span>
<span><span class="co">#&gt; [1] 2.697393</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; iteration = 3</span></span>
<span><span class="co">#&gt; Step:</span></span>
<span><span class="co">#&gt; [1] -0.02779249</span></span>
<span><span class="co">#&gt; Parameter:</span></span>
<span><span class="co">#&gt; [1] -1.572139</span></span>
<span><span class="co">#&gt; Function Value</span></span>
<span><span class="co">#&gt; [1] 572.7912</span></span>
<span><span class="co">#&gt; Gradient:</span></span>
<span><span class="co">#&gt; [1] -0.06718848</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; iteration = 4</span></span>
<span><span class="co">#&gt; Step:</span></span>
<span><span class="co">#&gt; [1] 0.0006754493</span></span>
<span><span class="co">#&gt; Parameter:</span></span>
<span><span class="co">#&gt; [1] -1.571464</span></span>
<span><span class="co">#&gt; Function Value</span></span>
<span><span class="co">#&gt; [1] 572.7912</span></span>
<span><span class="co">#&gt; Gradient:</span></span>
<span><span class="co">#&gt; [1] -0.0003774216</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; iteration = 5</span></span>
<span><span class="co">#&gt; Parameter:</span></span>
<span><span class="co">#&gt; [1] -1.57146</span></span>
<span><span class="co">#&gt; Function Value</span></span>
<span><span class="co">#&gt; [1] 572.7912</span></span>
<span><span class="co">#&gt; Gradient:</span></span>
<span><span class="co">#&gt; [1] -5.787579e-07</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Relative gradient close to zero.</span></span>
<span><span class="co">#&gt; Current iterate is probably solution.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Elapsed time:</span></span>
<span><span class="co">#&gt;    user  system elapsed </span></span>
<span><span class="co">#&gt;   4.116   0.000   4.116</span></span></code></pre></div>
<p>We can extract summary statistics with <code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code>:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">est1</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 1 × 10</span></span></span>
<span><span class="co">#&gt;   est.start incidence.rate     SE CI.lwr CI.upr coverage log.lik iterations</span></span>
<span><span class="co">#&gt;       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>       0.1          0.208 0.020<span style="text-decoration: underline;">9</span>  0.171  0.253     0.95   -<span style="color: #BB0000;">573.</span>          5</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 2 more variables: antigen.isos &lt;chr&gt;, nlm.convergence.code &lt;ord&gt;</span></span></span></code></pre></div>
<p>We can plot the log-likelihood curve with <code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code>:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">est1</span><span class="op">)</span></span></code></pre></div>
<p><img src="simulate_xsectionalData_files/figure-html/unnamed-chunk-3-1.png" width="672"></p>
<p>We can set the x-axis to a logarithmic scale, if desired:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">est1</span>, log_x <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="simulate_xsectionalData_files/figure-html/unnamed-chunk-4-1.png" width="672"></p>
</div>
<div class="section level2">
<h2 id="simulate-multiple-clusters-with-different-lambdas">Simulate multiple clusters with different lambdas<a class="anchor" aria-label="anchor" href="#simulate-multiple-clusters-with-different-lambdas"></a>
</h2>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">parallel</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RevolutionAnalytics/doparallel" class="external-link">doParallel</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading required package: foreach</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'foreach'</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:purrr':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     accumulate, when</span></span>
<span><span class="co">#&gt; Loading required package: iterators</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://renozao.github.io/doRNG/" class="external-link">doRNG</a></span><span class="op">)</span> <span class="co"># for reproducible results</span></span>
<span><span class="co">#&gt; Loading required package: rngtools</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://renozao.github.io/rngtools/" class="external-link">rngtools</a></span><span class="op">)</span></span>
<span><span class="va">n_cores</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html" class="external-link">detectCores</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co"># n_cores = 1</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">n_cores</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 3</span></span></code></pre></div>
<p>In the preceding code chunk, we have determined that we can use 3 CPU
cores to run computations in parallel.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu">doParallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/doParallel/man/registerDoParallel.html" class="external-link">registerDoParallel</a></span><span class="op">(</span>cores <span class="op">=</span> <span class="va">n_cores</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#number of clusters </span></span>
<span><span class="va">nclus</span> <span class="op">=</span> <span class="fl">10</span>;</span>
<span></span>
<span><span class="co"># cross-sectional sample size</span></span>
<span><span class="va">nrep</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span></span>
<span><span class="co">#incidence rate in e</span></span>
<span><span class="va">lmbdaVec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">.05</span>,<span class="fl">.1</span>, <span class="fl">.15</span>, <span class="fl">.2</span>, <span class="fl">.3</span><span class="op">)</span></span>
<span></span>
<span><span class="va">n_lambda</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">lmbdaVec</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#trying to reproduce results using parallel</span></span>
<span><span class="va">rng</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/rngtools/man/RNGseq.html" class="external-link">RNGseq</a></span><span class="op">(</span><span class="va">n_lambda</span> <span class="op">*</span> <span class="va">nclus</span>, <span class="fl">1234</span><span class="op">)</span></span>
<span></span>
<span><span class="va">sim.df</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/foreach/man/foreach.html" class="external-link">foreach</a></span><span class="op">(</span>i <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">lmbdaVec</span><span class="op">)</span>, </span>
<span>          .combine <span class="op">=</span> <span class="va">bind_rows</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/foreach/man/foreach.html" class="external-link">%:%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/foreach/man/foreach.html" class="external-link">foreach</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">nclus</span>,  </span>
<span>          r <span class="op">=</span> <span class="va">rng</span><span class="op">[</span><span class="op">(</span><span class="va">i</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="va">nclus</span> <span class="op">+</span> <span class="fl">1</span><span class="op">:</span><span class="va">nclus</span><span class="op">]</span>, </span>
<span>          .combine <span class="op">=</span> <span class="va">bind_rows</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/foreach/man/foreach.html" class="external-link">%dopar%</a></span> </span>
<span>  <span class="op">{</span></span>
<span>    <span class="va">l</span> <span class="op">=</span> <span class="va">lmbdaVec</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>    <span class="fu">rngtools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rngtools/man/rng.html" class="external-link">setRNG</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="../reference/sim.cs.html">sim.cs</a></span><span class="op">(</span></span>
<span>      lambda <span class="op">=</span> <span class="va">l</span>,</span>
<span>      n.smpl <span class="op">=</span> <span class="va">nrep</span>,</span>
<span>      age.rng <span class="op">=</span> <span class="va">lifespan</span>,</span>
<span>      antigen_isos <span class="op">=</span> <span class="va">antibodies</span>,</span>
<span>      n.mc <span class="op">=</span> <span class="fl">0</span>,</span>
<span>      renew.params <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>      add.noise <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>      curve_params <span class="op">=</span> <span class="va">dmcmc</span>,</span>
<span>      noise_limits <span class="op">=</span> <span class="va">dlims</span></span>
<span>    <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>lambda.sim <span class="op">=</span> <span class="va">l</span>, cluster <span class="op">=</span> <span class="va">n</span><span class="op">)</span> </span>
<span>  <span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">sim.df</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 5,000 × 5</span></span></span>
<span><span class="co">#&gt;      age HlyE_IgA HlyE_IgG lambda.sim cluster</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> 10.8     0.681    0.579       0.05       1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>  3.12    1.89   948.          0.05       1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>  0.9     0.632    0.173       0.05       1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> 11.7   845.      87.0         0.05       1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>  6.4     0.374    0.311       0.05       1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>  3.89    0.420    0.645       0.05       1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> 17.7     0.353    0.612       0.05       1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>  6.24    0.639    0.727       0.05       1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>  7.8     0.645    0.486       0.05       1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>  0.7     0.806    0.580       0.05       1</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 4,990 more rows</span></span></span></code></pre></div>
<p>We can plot the distributions of the simulated responses</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">sim.df.l</span> <span class="op">&lt;-</span> <span class="va">sim.df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"HlyE_IgG"</span>, <span class="st">"HlyE_IgA"</span><span class="op">)</span>, values_to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"value"</span><span class="op">)</span>, names_to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"antigen_iso"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">sim.df.l</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">cluster</span><span class="op">)</span>, y<span class="op">=</span> <span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/ggbeeswarm/man/geom_beeswarm.html" class="external-link">geom_beeswarm</a></span><span class="op">(</span>size<span class="op">=</span> <span class="fl">.2</span>, alpha <span class="op">=</span> <span class="fl">.3</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">antigen_iso</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html" class="external-link">geom_boxplot</a></span><span class="op">(</span>outlier.colour <span class="op">=</span> <span class="cn">NA</span>, fill <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_log10</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">antigen_iso</span> <span class="op">+</span> <span class="va">lambda.sim</span>, nrow <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_linedraw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="simulate_xsectionalData_files/figure-html/unnamed-chunk-5-1.png" width="672"></p>
<div class="section level3">
<h3 id="estimate-incidence-in-each-cluster">Estimate incidence in each cluster<a class="anchor" aria-label="anchor" href="#estimate-incidence-in-each-cluster"></a>
</h3>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ests</span> <span class="op">=</span></span>
<span>  <span class="va">sim.df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span></span>
<span>    cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"HlyE_IgG"</span>, <span class="st">"HlyE_IgA"</span><span class="op">)</span>, </span>
<span>    names_to <span class="op">=</span> <span class="st">"antigen_iso"</span>, </span>
<span>    values_to <span class="op">=</span> <span class="st">"value"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/est.incidence.by.html">est.incidence.by</a></span><span class="op">(</span></span>
<span>    curve_params <span class="op">=</span> <span class="va">dmcmc</span>,</span>
<span>    noise_params <span class="op">=</span> <span class="va">cond</span>,</span>
<span>    numCores <span class="op">=</span> <span class="va">n_cores</span>,</span>
<span>    strata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"lambda.sim"</span>, <span class="st">"cluster"</span><span class="op">)</span>,</span>
<span>    curve_strata_varnames <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    noise_strata_varnames <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    verbose <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    build_graph <span class="op">=</span> <span class="cn">TRUE</span>, <span class="co"># slows down the function substantially</span></span>
<span>    antigen_isos <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"HlyE_IgG"</span>, <span class="st">"HlyE_IgA"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt; Data has been stratified.</span></span>
<span><span class="co">#&gt; Here are the strata that will be analyzed:</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 50 × 4</span></span></span>
<span><span class="co">#&gt;    Stratum    lambda.sim cluster     n</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> Stratum 1        0.05       1   100</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> Stratum 2        0.05       2   100</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> Stratum 3        0.05       3   100</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> Stratum 4        0.05       4   100</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> Stratum 5        0.05       5   100</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> Stratum 6        0.05       6   100</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> Stratum 7        0.05       7   100</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> Stratum 8        0.05       8   100</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> Stratum 9        0.05       9   100</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> Stratum 10       0.05      10   100</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 40 more rows</span></span></span>
<span><span class="co">#&gt; Setting up parallel processing.</span></span>
<span><span class="co">#&gt; Elapsed time for parallelized code:</span></span>
<span><span class="co">#&gt;    user  system elapsed </span></span>
<span><span class="co">#&gt;   0.430   0.120 323.319</span></span></code></pre></div>
<p>We can extract a table listing the strata, using the
<code><a href="../reference/strata.html">strata()</a></code> method:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/strata.html">strata</a></span><span class="op">(</span><span class="va">ests</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 50 × 4</span></span></span>
<span><span class="co">#&gt;    Stratum    lambda.sim cluster     n</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> Stratum 1        0.05       1   100</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> Stratum 2        0.05       2   100</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> Stratum 3        0.05       3   100</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> Stratum 4        0.05       4   100</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> Stratum 5        0.05       5   100</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> Stratum 6        0.05       6   100</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> Stratum 7        0.05       7   100</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> Stratum 8        0.05       8   100</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> Stratum 9        0.05       9   100</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> Stratum 10       0.05      10   100</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 40 more rows</span></span></span></code></pre></div>
<p><code>summary(ests)</code> produces a <code><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble()</a></code> with some
extra meta-data:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">ests</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in FUN(X[[i]], ...): `nlm()` produced a negative hessian; something is wrong with the numerical derivatives.</span></span>
<span><span class="co">#&gt; The standard error of the incidence rate estimate cannot be calculated.</span></span>
<span><span class="co">#&gt; Warning in sqrt(var.log.lambda): NaNs produced</span></span>
<span><span class="co">#&gt; Seroincidence estimated given the following setup:</span></span>
<span><span class="co">#&gt; a) Antigen isotypes   : HlyE_IgG, HlyE_IgA </span></span>
<span><span class="co">#&gt; b) Strata       : lambda.sim, cluster </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Seroincidence estimates:</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 50 × 14</span></span></span>
<span><span class="co">#&gt;    Stratum  lambda.sim cluster     n est.start incidence.rate        SE   CI.lwr</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> Stratum…       0.05       1   100       0.1         0.057<span style="text-decoration: underline;">0</span>   0.008<span style="text-decoration: underline;">08</span>   0.043<span style="text-decoration: underline;">2</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> Stratum…       0.05       2   100       0.1         0.060<span style="text-decoration: underline;">7</span>   0.008<span style="text-decoration: underline;">14</span>   0.046<span style="text-decoration: underline;">6</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> Stratum…       0.05       3   100       0.1         0.052<span style="text-decoration: underline;">2</span>   0.007<span style="text-decoration: underline;">45</span>   0.039<span style="text-decoration: underline;">4</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> Stratum…       0.05       4   100       0.1         0.062<span style="text-decoration: underline;">5</span>   0.008<span style="text-decoration: underline;">18</span>   0.048<span style="text-decoration: underline;">3</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> Stratum…       0.05       5   100       0.1         0.067<span style="text-decoration: underline;">8</span>   0.008<span style="text-decoration: underline;">80</span>   0.052<span style="text-decoration: underline;">5</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> Stratum…       0.05       6   100       0.1         0.051<span style="text-decoration: underline;">1</span>   0.007<span style="text-decoration: underline;">47</span>   0.038<span style="text-decoration: underline;">4</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> Stratum…       0.05       7   100       0.1         0.053<span style="text-decoration: underline;">2</span>   0.007<span style="text-decoration: underline;">23</span>   0.040<span style="text-decoration: underline;">8</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> Stratum…       0.05       8   100       0.1         0.046<span style="text-decoration: underline;">9</span>   0.006<span style="text-decoration: underline;">81</span>   0.035<span style="text-decoration: underline;">3</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> Stratum…       0.05       9   100       0.1         0.044<span style="text-decoration: underline;">5</span> <span style="color: #BB0000;">NaN</span>       <span style="color: #BB0000;">NaN</span>     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> Stratum…       0.05      10   100       0.1         0.043<span style="text-decoration: underline;">7</span>   0.006<span style="text-decoration: underline;">58</span>   0.032<span style="text-decoration: underline;">5</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 40 more rows</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 6 more variables: CI.upr &lt;dbl&gt;, coverage &lt;dbl&gt;, log.lik &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   iterations &lt;int&gt;, antigen.isos &lt;chr&gt;, nlm.convergence.code &lt;ord&gt;</span></span></span></code></pre></div>
<p>We can explore the summary table interactively using
<code><a href="https://rdrr.io/pkg/DT/man/datatable.html" class="external-link">DT::datatable()</a></code></p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/DT" class="external-link">DT</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">ests</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">DT</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/DT/man/datatable.html" class="external-link">datatable</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in FUN(X[[i]], ...): `nlm()` produced a negative hessian; something is wrong with the numerical derivatives.</span></span>
<span><span class="co">#&gt; The standard error of the incidence rate estimate cannot be calculated.</span></span>
<span><span class="co">#&gt; Warning in sqrt(var.log.lambda): NaNs produced</span></span></code></pre></div>
<div class="datatables html-widget html-fill-item" id="htmlwidget-4d12c20f5c2182c1503e" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-4d12c20f5c2182c1503e">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39","40","41","42","43","44","45","46","47","48","49","50"],["Stratum 1","Stratum 2","Stratum 3","Stratum 4","Stratum 5","Stratum 6","Stratum 7","Stratum 8","Stratum 9","Stratum 10","Stratum 11","Stratum 12","Stratum 13","Stratum 14","Stratum 15","Stratum 16","Stratum 17","Stratum 18","Stratum 19","Stratum 20","Stratum 21","Stratum 22","Stratum 23","Stratum 24","Stratum 25","Stratum 26","Stratum 27","Stratum 28","Stratum 29","Stratum 30","Stratum 31","Stratum 32","Stratum 33","Stratum 34","Stratum 35","Stratum 36","Stratum 37","Stratum 38","Stratum 39","Stratum 40","Stratum 41","Stratum 42","Stratum 43","Stratum 44","Stratum 45","Stratum 46","Stratum 47","Stratum 48","Stratum 49","Stratum 50"],[0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.15,0.15,0.15,0.15,0.15,0.15,0.15,0.15,0.15,0.15,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.3,0.3,0.3,0.3,0.3,0.3,0.3,0.3,0.3,0.3],[1,2,3,4,5,6,7,8,9,10,1,2,3,4,5,6,7,8,9,10,1,2,3,4,5,6,7,8,9,10,1,2,3,4,5,6,7,8,9,10,1,2,3,4,5,6,7,8,9,10],[100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100],[0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1],[0.05704408511686442,0.06066396028358628,0.05215470064630743,0.06245377068187212,0.06777685260542102,0.05112452972194798,0.05321093239221036,0.04692453357312351,0.04447042597863812,0.04370902202332797,0.1007522469674772,0.1445139280136635,0.09831348531537076,0.1365295171736692,0.102686996014182,0.1169373217533029,0.1236129607688336,0.1067668705840774,0.1367899321963525,0.1156475837770444,0.1789982973488358,0.2009317244257242,0.1839669130963298,0.1443823004299538,0.1693560242893659,0.170025031505875,0.2037611687476963,0.2307563936907528,0.18906849777386,0.2109988250476258,0.237545904713907,0.2186917509205258,0.2273771260123343,0.2423418222372817,0.1884127481790557,0.2522700153347117,0.2261109426065713,0.2198741492065815,0.2111979652143945,0.3160451103538525,0.4532248431806861,0.3540191692963724,0.3415270953585172,0.3649222303410204,0.4285077059196405,0.3242278797230386,0.2965231091108971,0.3828460317861705,0.3146554118681448,0.291168716308306],[0.00808049814628203,0.008138358409012043,0.007445658787011197,0.008184798515490392,0.008799260568161792,0.007466117906675795,0.007233862009935341,0.006812275714328899,null,0.006578541679807141,0.01142735965886233,0.0156139048621747,0.01120799810678567,0.01439877349619439,0.01177375876440219,0.01384692624278645,0.01380279749737295,0.01225683474326764,0.01525852181575383,0.01278386527848816,0.01910147034491224,0.02086457549896052,0.02628605484146307,0.01524163439835182,0.01808061048348104,0.01792723510792175,0.02083852690717702,0.02460258240987734,0.01882235049051611,0.02127513553248834,0.0243854506388133,0.02215068516957034,0.02391858210613505,0.02459256706748018,0.01938783996161268,0.02552571337067755,0.02347344392377851,0.02287635299371128,0.02165023655038899,0.03357777806811946,0.04764167203130892,0.03782467370194918,0.03663583992724623,0.03969585281544682,0.04482776108483366,0.03276387607238383,0.0306139871191503,0.03979831612354771,0.03563679162523088,0.0454871442261752],[0.04321503650542133,0.04663779709792918,0.0394253037410515,0.04830649661840961,0.05254997525348273,0.03839915413805321,0.04076454944463188,0.03530422331476432,null,0.03254308760802745,0.08066982692399088,0.1169343857407407,0.07862738983527795,0.1110341389423188,0.08201993750063911,0.09271705249221206,0.09931563968497104,0.08525475137085689,0.1099271733795895,0.093120094917909,0.1452160136155218,0.1639307717868393,0.1390324112437824,0.1173970966192829,0.1373806485428435,0.1382812178176669,0.1667514331492411,0.1872410573558093,0.155553376252531,0.1731621163692722,0.1942525923411789,0.179314967413306,0.1850145800133101,0.1986320952410757,0.1540000584420781,0.2068890832494136,0.1844824614430897,0.1793133649887658,0.1727554339544609,0.2566340858399356,0.368839892508282,0.2871318457260432,0.2767682104864038,0.2948543370785605,0.3490690340716417,0.265971276067524,0.2422020393647648,0.3122759072215273,0.2520176986612218,0.2143718537040629],[0.07529850510277493,0.078908445644658,0.06899408606644745,0.08074428380089561,0.08741586893121363,0.06806706027673072,0.06945749099702701,0.06236964431771964,null,0.05870612614411268,0.1258341024898944,0.1785982391547476,0.1229284275505603,0.1678790796888036,0.1285616579546219,0.1474845980461263,0.1538545602536101,0.1337070892944247,0.1702171080636276,0.1436248926212845,0.2206395125169414,0.2462841932641742,0.2434239959691852,0.1775703937981491,0.2087736756764233,0.209055949859305,0.2489850498152442,0.2843848137856589,0.2298046992720448,0.2571030263717591,0.2904880504618451,0.2667155040686045,0.2794393686698073,0.29567003627489,0.230515261068788,0.3076052135639014,0.2771328936447646,0.2696098056736982,0.2581949492972739,0.3892098411310702,0.5569157855438457,0.4364878855996782,0.4214384183033032,0.4516407508755202,0.5260244711217433,0.3952446277056198,0.3630273075627302,0.4693640484740968,0.392861409114781,0.395477390766342],[0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95],[-372.1152022802894,-362.0776871034597,-329.4521169694935,-360.8726626477913,-350.8544194334197,-257.9826382593942,-309.454207836288,-288.3031752077979,-320.2250443154152,-253.6138585577025,-475.9075953320682,-494.8518287700178,-453.8613931208273,-537.7339217137771,-418.0534541237583,-431.4119350834197,-519.9655061299246,-489.2438125889937,-483.0588623833879,-533.0803039914683,-583.8593156970725,-584.9411132421712,-608.0279743312572,-530.840120004881,-643.0066972623393,-614.7399704693551,-613.1884748816249,-682.4665589743256,-555.581735619512,-632.8727486629091,-691.0112695929529,-635.7859548343104,-704.4303870555758,-630.658725864185,-573.0977830923155,-687.2246919088589,-693.9581755897939,-609.3739649696493,-661.8309473629481,-696.2480738342338,-874.3161743760933,-782.0258969086366,-713.6400724275675,-697.8042795460126,-781.9042490001798,-697.7439483555047,-671.7079073045304,-752.0298643652945,-830.7900414785586,-709.6900474938641],[5,5,6,5,5,6,6,6,9,6,1,4,2,4,2,4,4,3,4,6,5,5,7,4,4,4,5,7,5,5,9,4,5,4,4,4,5,5,4,4,6,3,4,4,4,4,4,4,9,8],["HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA"],["1","1","1","1","1","1","1","1","3","1","1","1","1","1","1","1","1","1","1","2","1","1","3","1","1","1","1","3","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","2","2"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>Stratum<\/th>\n      <th>lambda.sim<\/th>\n      <th>cluster<\/th>\n      <th>n<\/th>\n      <th>est.start<\/th>\n      <th>incidence.rate<\/th>\n      <th>SE<\/th>\n      <th>CI.lwr<\/th>\n      <th>CI.upr<\/th>\n      <th>coverage<\/th>\n      <th>log.lik<\/th>\n      <th>iterations<\/th>\n      <th>antigen.isos<\/th>\n      <th>nlm.convergence.code<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[2,3,4,5,6,7,8,9,10,11,12]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script><p>We can plot the likelihood for a single simulated cluster by
subsetting that simulation in <code>ests</code> and calling
<code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code>:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ests</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p><img src="simulate_xsectionalData_files/figure-html/unnamed-chunk-9-1.png" width="672"></p>
<p>We can also plot log-likelihood curves for several clusters at once
(your computer might struggle to plot many at once):</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ests</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p><img src="simulate_xsectionalData_files/figure-html/plot-multiple-1.png" width="672"></p>
<p>The <code>log_x</code> argument also works here:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ests</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span>, log_x <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="simulate_xsectionalData_files/figure-html/plot-multiple-log-1.png" width="672"></p>
<div class="section level4">
<h4 id="nlm-convergence-codes">
<code>nlm()</code> convergence codes<a class="anchor" aria-label="anchor" href="#nlm-convergence-codes"></a>
</h4>
<p>Make sure to check the <code><a href="https://rdrr.io/r/stats/nlm.html" class="external-link">nlm()</a></code> exit codes (codes 3-5
indicate possible non-convergence):</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">ests</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="co"># removes extra meta-data</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">Stratum</span>, <span class="va">nlm.convergence.code</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">nlm.convergence.code</span> <span class="op">&gt;</span> <span class="fl">2</span><span class="op">)</span> </span>
<span><span class="co">#&gt; Warning in FUN(X[[i]], ...): `nlm()` produced a negative hessian; something is wrong with the numerical derivatives.</span></span>
<span><span class="co">#&gt; The standard error of the incidence rate estimate cannot be calculated.</span></span>
<span><span class="co">#&gt; Warning in sqrt(var.log.lambda): NaNs produced</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 3 × 2</span></span></span>
<span><span class="co">#&gt;   Stratum    nlm.convergence.code</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;ord&gt;</span>               </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> Stratum 9  3                   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> Stratum 23 3                   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> Stratum 28 3</span></span></code></pre></div>
<p>Solutions to <code><a href="https://rdrr.io/r/stats/nlm.html" class="external-link">nlm()</a></code> exit codes 3-5:</p>
<ul>
<li>3: decrease the <code>stepmin</code> argument to
<code><a href="../reference/est.incidence.html">est.incidence()</a></code>/<code><a href="../reference/est.incidence.by.html">est.incidence.by()</a></code>
</li>
<li>4: increase the <code>iterlim</code> argument to
<code><a href="../reference/est.incidence.html">est.incidence()</a></code>/<code><a href="../reference/est.incidence.by.html">est.incidence.by()</a></code>
</li>
<li>5: increase the <code>stepmax</code> argument to
<code><a href="../reference/est.incidence.html">est.incidence()</a></code>/<code><a href="../reference/est.incidence.by.html">est.incidence.by()</a></code>
</li>
</ul>
<p>We can extract the indices of problematic strata, if there are
any:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">problem_strata</span> <span class="op">=</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">ests</span><span class="op">)</span><span class="op">$</span><span class="va">nlm.convergence.code</span> <span class="op">&gt;</span> <span class="fl">2</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in FUN(X[[i]], ...): `nlm()` produced a negative hessian; something is wrong with the numerical derivatives.</span></span>
<span><span class="co">#&gt; The standard error of the incidence rate estimate cannot be calculated.</span></span>
<span><span class="co">#&gt; Warning in sqrt(var.log.lambda): NaNs produced</span></span>
<span><span class="co">#&gt; [1]  9 23 28</span></span></code></pre></div>
<p>A few clusters had problems; let’s take a look:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ests</span><span class="op">[</span><span class="va">problem_strata</span><span class="op">]</span>, log_x <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="simulate_xsectionalData_files/figure-html/unnamed-chunk-12-1.png" width="672"></p>
<p>Visually, it looks like we approximately reached the MLE, but we
should probably re-run those clusters, adjusting the <code><a href="https://rdrr.io/r/stats/nlm.html" class="external-link">nlm()</a></code>
settings appropriately, to be sure.</p>
</div>
</div>
<div class="section level3">
<h3 id="plot-distribution-of-estimates-by-simulated-incidence-rate">plot distribution of estimates by simulated incidence rate<a class="anchor" aria-label="anchor" href="#plot-distribution-of-estimates-by-simulated-incidence-rate"></a>
</h3>
<p>Finally, we can look at our simulation results:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">ests</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span>xvar <span class="op">=</span> <span class="st">'lambda.sim'</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in FUN(X[[i]], ...): `nlm()` produced a negative hessian; something is wrong with the numerical derivatives.</span></span>
<span><span class="co">#&gt; The standard error of the incidence rate estimate cannot be calculated.</span></span>
<span><span class="co">#&gt; Warning in sqrt(var.log.lambda): NaNs produced</span></span></code></pre></div>
<p><img src="simulate_xsectionalData_files/figure-html/graph-1.png" width="672"></p>
</div>
<div class="section level3">
<h3 id="extra-remove">extra (remove?)<a class="anchor" aria-label="anchor" href="#extra-remove"></a>
</h3>
<p>We can calculate the log-likelihood of the data as a function of the
incidence rate, even without running <code><a href="../reference/est.incidence.html">est.incidence()</a></code>.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="../reference/graph_loglik.html">graph_loglik</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">csdataL</span>,</span>
<span>  curve_params <span class="op">=</span> </span>
<span>    <span class="va">dmcmc</span> <span class="op">|&gt;</span> <span class="co"># llik() is a lower-level function, it assumes this transformation is already done</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    alpha <span class="op">=</span> <span class="va">.data</span><span class="op">$</span><span class="va">alpha</span> <span class="op">*</span> <span class="fl">365.25</span>,</span>
<span>    d <span class="op">=</span> <span class="va">.data</span><span class="op">$</span><span class="va">r</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>  noise_params <span class="op">=</span> <span class="va">cond</span>,</span>
<span>  antigen_isos <span class="op">=</span> <span class="va">antibodies</span>,</span>
<span>  log_x <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="simulate_xsectionalData_files/figure-html/unnamed-chunk-13-1.png" width="672"></p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Peter Teunis, Kristina Lai, Kristen Aiemjoy, Douglas Ezra Morrison.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
