#' Plot distribution of antibodies
#' @description
#' `autoplot()` method for `pop_data` objects
#'
#' @param object A `pop_data` object (from [load_pop_data()])
#' @param log whether to show antibody responses on logarithmic scale
#' @param strata the name of a variable in `pop_data` to stratify by (or `NULL` for no stratification)
#' @param ... unused
#' @param type an option to choose type of chart,{'density','age-scatter'}
#'
#' @return a [ggplot2::ggplot] object
#' @export
#' @examples
#' library(dplyr)
#' library(ggplot2)
#'
#'
#' xs_data <- "https://osf.io/download//n6cp3/" %>%
#' load_pop_data() %>%
#' clean_pop_data()
#'
#' xs_data %>% autoplot(strata = "Country",type='density')
#'

autoplot.pop_data = function(
    object,
    log =  FALSE,
    type = NULL,
    strata = NULL,
    ...)
{

  # age-scatter plotting function
  age_scatter = function(
    object,
    strata = NULL
  )
  {
    # create basic plotting features
    options(scipen = 999)
    plot1 =
      object %>%
      ggplot2::ggplot(aes(x = .data$age,y = .data$value)) +
      ggplot2::theme_linedraw()

    if(is.null(strata))
    {
      plot1 = plot1 +
        ggplot2::geom_point(size=.6, alpha=.7) +
        ggplot2::geom_smooth(method="lm", se=FALSE) +
        ggplot2::scale_y_log10() +
        ggplot2::theme_linedraw() +
        ggplot2::labs(
          title = "Quantitative Antibody Responses by Age",
          x = "Age",
          y = "Value"
        )
    } else
    {
      plot1 = plot1 +
        ggplot2::geom_point(size=.6,
                            alpha=.7,
                            aes(color = get(strata))) +
        ggplot2::geom_smooth(method=lm,
                             se=FALSE,
                             aes(color = get(strata))
        ) +
        ggplot2::scale_y_log10() +
        ggplot2::labs(
          title = "Quantitative Antibody Responses by Age",
          x = "Age",
          y = "Value",
          colour = strata
        )
    }

  return(plot1)
  }

  # density plotting function
  density_plot = function(
    object,
    log = FALSE,
    strata = NULL
  )

  {
    plot1 =
      object %>%
      ggplot2::ggplot(aes(x = .data$value)) +
      ggplot2::theme_linedraw() +
      ggplot2::facet_wrap(~antigen_iso, nrow = 3)

    if(is.null(strata))
    {
      plot1 = plot1 +
        ggplot2::geom_density(alpha = .6,
                              color = "black")
    } else
    {
      plot1 = plot1 +
        ggplot2::geom_density(
          aes(fill = get(strata)),
          alpha = .6,
          color = "black") +
        ggplot2::labs(fill = strata)
    }
    if(log)
    {
      plot1 = plot1 +
        ggplot2::scale_x_log10() +
        ggplot2::labs(
          title = "Distribution of Cross-sectional Antibody Responses (Log transformed)",
          x = "Log10(Antibody Response Value)",
          y = "Frequency"
        )
    } else
    {
      plot1 = plot1 +
        ggplot2::labs(
          title = "Distribution of Cross-sectional Antibody Responses",
          x = "Antibody Response Value",
          y = "Frequency"
        )
    }
    return(plot1)
  }

  # type error function
  err_type = function()
  {
    return("Error:Select the correct type: {'density','age-scatter'}")
  }


  if(type == 'age-scatter')
  {
    age_scatter(object,strata)
  } else if (type == 'density')
  {
    density_plot(object,strata,log=FALSE)
  } else
  {
    err_type()
  }

}
